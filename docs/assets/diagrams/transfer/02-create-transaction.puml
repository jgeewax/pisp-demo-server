@startuml

title Create Transaction

hide footbox

autonumber

box "Mobile Device" #Light
  actor Alice
  participant "PISP App" as App
end box
box "PISP" #Light
  database Firebase
  participant "PISP Server" as Server
end box
box "Mojaloop" #Light
  participant "Third-party\nAPI Adapter" as Adapter
end box

Alice -> App: I want to make this transaction

rnote right of App #Light 
  ""createDoc(""
  ""  "transactions/users/1234/<uuid>",""
  ""  {""
  ""    payee: {""
  ""      partyIdInfo: {""
  ""        partyIdType: "MSISDN",""
  ""        partyIdentifier: "+1-222-222-2222"""
  ""      }""
  ""    },""
  ""    status: "PENDING"""
  ""  }""
  "")""
end rnote

App -> Firebase: Create a new document in the database
return ""200 OK""

rnote right of Firebase #Light
  ""event(""
  ""  "document.create",""
  ""  "transactions/users/1234/<uuid>",""
  ""  <snapshot object>""
  "")""
end rnote

Firebase -> Server: Notify event for new document
return ""200 OK""

Server -> Adapter: ""**GET /parties/MSISDN/+1-222-222-2222**""
return ""202 Accepted""

Adapter -> Adapter: Lookup data

rnote left of Adapter #Light
  ""**PUT /parties/MSISDN/+1-222-222-2222**""
  ""{ ""
  ""  "party": {""
  ""    "partyIdInfo": {""
  ""      "partyIdType": "MSISDN",""
  ""      "partyIdentifier": "+1-222-222-2222",""
  ""      "fspId": "fspa"""
  ""    },""
  ""    "name": "Alice Alpaca",""
  ""    "personalInfo": {""
  ""      "complexName": {""
  ""        "firstName": "Alice",""
  ""        "middleName": "K",""
  ""        "lastName": "Alpaca"""
  ""      },""
  ""      "dateOfBirth": "1971-12-25"""
  ""    }""
  ""  },""
  "" "accounts": [""
  ""    {""
  ""      "id": "alice.fspa",""
  ""      "currency": "USD"""
  ""    }""
  ""  ]""
  ""} ""
end rnote

Adapter -> Server: ""**PUT /parties/MSISDN/+1-222-222-2222**""

return ""200 OK""

deactivate Adapter

rnote left of Server #Light
  ""updateDoc(""
  ""  "transactions/users/1234/<uuid>",""
  ""  {""
  ""    payee: {""
  ""      name: "Alice Alpaca",""
  ""      partyIdInfo: {""
  ""        partyIdType: "MSISDN",""
  ""        partyIdentifier: "+1-222-222-2222",""
  ""        fspId: "fspa"""
  ""      }""
  ""    },""
  ""    status: "PENDING_PAYEE_CONFIRMATION"""
  ""  }""
  "")""
end rnote

Server -> Firebase: Update transaction data
return ""200 OK""

rnote left of Firebase #Light
  ""event(""
  ""  "document.update",""
  ""  "transactions/users/1234/<uuid>",""
  ""  <snapshot object>""
  "")""
end rnote

Firebase -> App: Notify update on transaction status
return ""200 OK""

App -> Alice: Display party information

@enduml
